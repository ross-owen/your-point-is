<section id="voted-section" class="hidden">
    <h2 id="votedMessage">All votes are in for an average of: <span id="average-vote"></span></h2>

    <div id="pieChart">
        <canvas id="myChart"></canvas>

    </div>

    <!-- Accessing chart.js via cdn for ease and lack of installation -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <% if (isOwner) { %>
      <!-- The button group allows for better formatting for the owner -->
      <div class="button-group">
        <div class="owner-button">
            <button id="new-round-button" class="btn btn-secondary btn-lg mt-4">Start a New Round</button>
        </div>
      </div>
    <% } %>
</section>

<script>

  const newRoundButton = document.getElementById('new-round-button');
  if (newRoundButton) {
    newRoundButton.addEventListener("click", () => {
      newRound();
    });
  }

  // called from room/index.ejs
  function showVoted(votes) {

    resetVotedCards();

    countCards(votes);

    const section = document.getElementById("voted-section");
    if (section) {
      section.classList.remove("hidden");
    }
  }

  // called from room/index.ejs
  function hideVoted() {
    resetVotedCards();

    const section = document.getElementById("voted-section");
    if (section) {
      section.classList.add("hidden");
    }
  }

  function resetVotedCards() {
    const voteCounts = document.querySelectorAll(".vote-count");
    voteCounts.forEach(element => {
      element.innerHTML = "";
    });
    const cards = document.querySelectorAll(".voted-card-wrapper");
    cards.forEach(element => {
      element.classList.add("hidden");
    });
    document.getElementById("average-vote").innerHTML = "";
  }

  // define myChart as global for global access to delete
  let myChart;

  // loops through all the cards
  // counts how many people voted for that card
  // sums the values of the cards and calculates the average
  function countCards(voteCounts) {
    const cardVoteSummary = {};

    voteCounts.forEach(vote => {
      if (!cardVoteSummary[vote.card]) {
        cardVoteSummary[vote.card] = {
          count: 0,
          names: [],
        };
      }

      cardVoteSummary[vote.card].count++;
      cardVoteSummary[vote.card].names.push(vote.name);
    });

    // Call the createChart function to display the Pie Chart
    createChart(cardVoteSummary);

    let sum = 0;
    let voterCount = 0;

    // get the average
    // handle ½ card since it's NaN, but is actually 0.5
    for (const card in cardVoteSummary) {
      if (cardVoteSummary.hasOwnProperty(card)) {
        const summary = cardVoteSummary[card];

        if (!isNaN(card)) {
          sum += (Number(card) * summary.count);
          voterCount += summary.count;
        } else if (card === "½") {
          sum += (0.5 * summary.count);
          voterCount += summary.count;
        }
      }
    }

    document.getElementById("average-vote").innerHTML = `${(sum / voterCount).toFixed(2)}`;
  }

  function newRound() {
    hideVoted();
    hideWaiting();
    getSocket().emit("new_round", roomCode);
  }

  // Chart as global variable
  const ctx = document.getElementById('myChart');


  function createChart(data) {

    // Takes in the data in the form of an object with arrays, each having
    // the cardName, number of votes for that card, and names of the voters

    // The function then deletes any existing charts, inputs the data appropriately,
    // and creates a new chart

    if (myChart !== undefined) {
      myChart.destroy();
    }

    // create three arrays. one for the labels, one for the card (how many times it was voted) and the voter names
    // they will always be the same size, so we can use the index to retrieve each one
    let labelList = [];
    let cardCount = [];
    let voterNames = [];

    for (const item in data) {
      if (data.hasOwnProperty(item)) {
        let card = data[item];
        if (item !== "?") {
          labelList.push(item);
          cardCount.push(card.count);
          voterNames.push(card.names.join(", ")); // combine all the voter names into a single string to use for hover
        }
      }
    }

    // Creates the new chart
    Chart.register(ChartDataLabels);

    myChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labelList,
        datasets: [{
          label: '# of Votes',
          data: cardCount,
          descriptions: voterNames,
          borderWidth: 3
        }]
      },
      options: {
        plugins: {
          datalabels: {
            align: 'center',
            color: '#fff',
            font: {
              weight: 'bold',
              size: 72
            },
            formatter: function (value, context) {
              return context.chart.data.labels[context.dataIndex];
            }
          },
          tooltip: {
            displayColors: false,
            titleFont: {
              size: 12
            },
            bodyFont: {
              size: 18
            },
            callbacks: {
              title: (context) => {
                return `${context[0].formattedValue} vote(s)`;
              },
              label: function (context) {
                return context.dataset.descriptions[context.dataIndex];
              }
            }
          }
        }
      }
    });
  }
</script>